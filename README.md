## Container Runtime Security Monitoring on Amazon Elastic Kubernetes Service (EKS) with CNCF Falco and AWS Security Hub

### Features and benefits

* Amazon Security Hub collects security findings from other AWS services using a standardized AWS Security Findings Format (ASFF). 
* CNCF Falco provides the ability to detect security events at runtime for containers and send them via integrations to external Log management systems Security Hub provides a custom integrations feature using ASFF to enable collection and aggregation of findings that are generated by custom security products.
* This guidance uses integration with Amazon FireLens/FluentBit with Amazon CloudWatch Logs and Lambda to enrich security events logs received from Falco, process them into ASFF format and import into Security Hub.
*  Using Security Hub cross-region configurable aggregation, it is possible to ingest and aggregate security events from multiple Amazon EKS platform deployments in various regions thus providing Security and DevOps teams with a "single pane of glass" Security management portal that contains security incidents from all those platforms and allows for ITIL style automation of remediation.


### Use cases

* Consolidate all of customers' Container security events from multiple application platforms in one place for continuous log retention for security, compliance and audit purposes.
* Format security events into AWS Standard format (ASFF) and import them into central security events monitoring and management portal (Security Hub).
* Aggregate security events from multiple Container application platforms possibly deployed in different AWS regions into "Single pane of glass" portal for Security, DevOps and other teams to efficiently detect container Security threats and collaborate on their triage & resolution.
* Provide security mitigation workflow options to remediate certain Security incidents with AWS services

## Architecture overview

This section provides an architecture diagram and describes the components deployed with this Guidance.

![](static/falco_eks_integration_architecture_updated.png)

### Architecture steps

1. Users interact with Extraction, Transformation and Loading (ETL) development and orchestration tools via [Amazon CloudFront](https://aws.amazon.com/cloudfront/) endpoints with [Application Load Balancer](https://aws.amazon.com/elasticloadbalancing/application-load-balancer/) origins, which provide secure connections between clients and ETL tools’ endpoints.
2. Users interactively develop, test and schedule ETL jobs that process batch and stream data. The data traffic between ETL processes and data stores flows through [Amazon Virtual Private Cloud (VPC)](https://aws.amazon.com/vpc/) Endpoints ([AWS PrivateLink](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)) without leaving the AWS network.
3. [JupyterHub](https://jupyter.org/hub), [Argo Workflows](https://argoproj.github.io/workflows/) and [Kubernetes Operator for Apache Spark](https://github.com/kubeflow/spark-operator/tree/master) are running as containers on [Amazon Elastic Kubernetes Service (EKS)](https://aws.amazon.com/eks/) cluster. JupyterHub IDE can integrate with a source code repository (GitHub) to track ETL assets changes made by users. The assets include JupyterHub notebook files, SQL scripts etc., to be run with the [Arc ETL framework](https://arc.tripl.ai/).
4. ETL assets can be updated by users in the source code repository (GitHub), then uploaded to an [Amazon S3](https://aws.amazon.com/s3/) bucket. The synchronization process can be implemented by an automated [CI/CD](https://about.gitlab.com/topics/ci-cd/) deployment process triggered by updates in the source code repository or performed manually.
5. Users can change Docker build source code uploaded from a code repository to the S3 ETL Asset bucket. It activates an [AWS CodeBuild](https://aws.amazon.com/codebuild/) /[AWS CodePipeline](https://aws.amazon.com/codepipeline) CI/CD pipeline to automatically rebuild and push the [Arc ETL Framework container image](https://github.com/tripl-ai/docker) to [Amazon ECR](https://aws.amazon.com/ecr) private registry. 
6. Users schedule ETL jobs via Argo Workflows to be run on [Amazon EKS](https://aws.amazon.com/eks/) cluster. These jobs automatically pull Arc ETL Framework container image from ECR, download ETL assets from the artifact S3 bucket, and send application execution logs to [Amazon CloudWatch](https://aws.amazon.com/cloudwatch/). Access to all the AWS services is secured via VPC endpoints.
7. JupyterHub IDE automatically retrieves login credentials from [Amazon Secrets Manager](https://aws.amazon.com/secrets-manager/) to validate sign-in user requests. Authenticated users can interactively develop and test their notebooks as ETL jobs in JupyterHub.
8. Users can access the ETL output data stored in the S3 bucket that supports the transactional Data lake format and query the [Delta Lake](https://docs.aws.amazon.com/athena/latest/ug/delta-lake-tables.htm) tables through [Amazon Athena](https://aws-preview.aka.amazon.com/athena/) integrated with [AWS Glue Data Catalog](https://docs.aws.amazon.com/prescriptive-guidance/latest/serverless-etl-aws-glue/aws-glue-data-catalog.html).

### AWS Services used  in this Guidance

| **AWS service**  | Description |
|-----------|------------|
|[Amazon Elastic Kubernetes Service - EKS](https://aws.amazon.com/eks/)|Core service - The EKS service is used to host the guidance workloads|
|[Amazon Virtual Private Cloud - VPC](https://aws.amazon.com/vpc/)| Core Service - network security layer |
|[Amazon Elastic Compute Cloud - EC2](https://aws.amazon.com/ec2/)| Core Service - EC2 instance power On Demand and Spot based EKS compute node groups for running container workloads|
|[Amazon Elastic Container Registry - ECR](https://aws.amazon.com/ecr/)|Core service - ECR registry is used to host the container images for Spark jobs and Arc ETL Framework|
|[Amazon Elastic Map Reduce EMR on EKS](https://aws.amazon.com/emr/features/eks/)| Auxiliary service - alternative way to configure and run ETL Jobs on EKS| 
|[Amazon Athena](https://aws.amazon.com/athena/)| Core service - used for SQL syntax Querying of Sample ETL job results from S3|
|[AWS Glue Data Catalog](https://docs.aws.amazon.com/glue/latest/dg/components-overview.html#data-catalog-intro)| Auxiliary service - exposes ETL related data stores |
|[Amazon S3](https://aws.amazon.com/s3/)|Core service - Object storage for users' ETL assets from GitHub|
|[Amazon CloudFront](https://aws.amazon.com/cloudfront/)|Auxiliary service - provides SSL entrypoints for Jupyter and Argo Workflows tools |
|[Amazon CloudWatch](https://aws.amazon.com/cloudwatch/)|Auxiliary service - provides observability for core services  |
|[AWS Secretes Manager](https://aws.amazon.com/secrets-manager/)|Auxiliary service - provides user credentials management for Jupyter IDE |
|[AWS CodeBuild](https://aws.amazon.com/codebuild/)| Core service - CI/CD automation for building Arc ETL framework images  |
|[AWS CodePipeline](https://aws.amazon.com/codepipeline)| Core service - CI/CD automation for pushing Arc ETL framework images into ECR registry|

## Plan your deployment

### Cost 

You are responsible for the cost of the AWS services used while running this Guidance. As of February 2024, the estimated cost for running this Guidance with the default two-node Amazon EKS cluster in the US East (N. Virginia) Region is approximately **\$0.64 an hour** or **\$467.76 per month**. Refer to the AWS pricing [webpage](https://aws.amazon.com/pricing/?aws-products-pricing) for each AWS service used in this Guidance.

### Sample Cost table

The following table provides a sample cost breakdown for deploying this
Guidance with the default parameters in the US East (N. Virginia) Region
for one month.

| **AWS service**  | Rate | Cost \[USD\] |
|-----------|------------|------------|
| Amazon EKS cluster (no compute) |  \$0.10 per hour per cluster X 1 | \$73.00 |
| Amazon EC2 (On-Demand) | \$0.1632 per hour X 1 m7g.xlarge instance | \$119.14|
| Amazon EC2 (Spot) | \$0.1174 per hour X 1 r4.xlarge instance | \$85.70 |
| Amazon EC2 (Graviton Spot) | \$0.0966 per hour X 1 r7g.xlarge instance | \$70.52 | 
| Elastic Load Balancing | \$0.0225 Application Load Balancer per hour X 2 ALBs | \$32.85 |
| Elastic Load Balancing | \$0.008 Load Balancer Capacity Units (LCU) per hour X 2 ALBs | \$11.68 |
| VPC Endpoint | \$0.01 per hour per VPC endpoint per Availability Zone (AZ) X 5 endpoints (Amazon S3, Amazon Athena, Amazon ECR, AWS KMS, and Amazon CloudWatch) X 2 AZs | \$73.00 |
| VPC Endpoint | \$0.01 per GB data processed per month X 10 GB | \$0.1 |
| Amazon S3 (storage) |  \$0.023 per GB for First 50 TB/month X 1 GB | \$0.02 |
| AWS CodeBuild | \$0.005 per build minute on general1.small X 150 minutes per month | \$0.75 |
| AWS CodePipeline | \$1.00 per active pipeline per month X 1 | \$1.00 |
|**Total estimated cost per month:**| | **\$467.76** |

Amazon CloudFront cost is not included in the estimation table, as its monthly [Free Tier](https://aws.amazon.com/cloudfront/pricing/) can fully covered the usage. To avoid the instance capacity issue, additional types of r5.xlarge and 5a.xlarge are included in the EC2 Spot Instance fleet, and r6g.xlarge,r6gd.xlarge are included in the Graviton Spot instance fleet. Their pricing varies based on the time period your instances are running. For more information on Spot Instances pricing, refer to the [Amazon EC2 Spot Instances Pricing page](https://aws.amazon.com/ec2/spot/pricing)

## Deployment

The project deploys a Lambda function, that enables receiving Falco security findings from AWS CloudWatch logs, formatting them in ASFF JSON format and integrating into Security Hub

The `cdk.json` file instructs the CDK Toolkit how to execute your application. It was updated for CDK 2.0 per document: https://docs.aws.amazon.com/cdk/v2/guide/migrating-v2.html.

This project is set up like a standard Python project.  The initialization
process also creates a virtualenv within this project, stored under the `.venv`
directory.  To create the virtualenv it assumes that there is a `python3`
(or `python` for Windows) executable in your path with access to the `venv`
package. If for any reason the automatic creation of the virtualenv fails,
you can create the virtualenv manually.

To manually create a virtualenv on MacOS and Linux:

```
python3 -m venv .venv
```

After the init process completes and the virtualenv is created, you can use the following
steps to activate your virtualenv:

```
source .venv/bin/activate
```

If you are running the sample on a Windows platform, you would activate the virtualenv like this:

```
% .venv\Scripts\activate.bat
```

Once the virtualenv is activated, you can install the required dependencies.

```
python -m pip install -r requirements.txt
```

At this point you can now synthesize the CloudFormation template for this code.

```
cdk synth
```

To add additional dependencies, for example other CDK libraries, just add them to the `setup.py` file and rerun the `python -m pip install -r requirements.txt` command (or `pip install -r requirements.txt` from pip command prompt).

You may need to bootstrap your Account/region to cdk using command like:
```
cdk bootstrap aws://<account ID>/<us-west-2>
......
[WARNING] @aws-cdk/aws-lambda.Code#asset is deprecated.
  use `fromAsset`
  This API will be removed in the next major release.
 ⏳  Bootstrapping environment aws://<account ID>/us-west-2...
Trusted accounts for deployment: (none)
Trusted accounts for lookup: (none)
Using default execution policy of 'arn:aws:iam::aws:policy/AdministratorAccess'. Pass '--cloudformation-execution-policies' to customize.
CDKToolkit: creating CloudFormation changeset...
 ✅  Environment aws://<account ID>/us-west-2 bootstrapped.
```
Then initialize deployment of artifacts into target Account/Region environment:

```
cdk deploy
...
[WARNING] @aws-cdk/aws-lambda.Code#asset is deprecated.
  use `fromAsset`
  This API will be removed in the next major release.

✨  Synthesis time: 1.03s

This deployment will make potentially sensitive changes according to your current security approval level (--require-approval broadening).
Please confirm you intend to make the following modifications:

IAM Statement Changes
┌───┬───────────────────┬────────┬─────────────────────────────────┬──────────────────────────────┬───────────┐
│   │ Resource          │ Effect │ Action                          │ Principal                    │ Condition │
├───┼───────────────────┼────────┼─────────────────────────────────┼──────────────────────────────┼───────────┤
│ + │ ${CustomRole.Arn} │ Allow  │ sts:AssumeRole                  │ Service:lambda.amazonaws.com │           │
├───┼───────────────────┼────────┼─────────────────────────────────┼──────────────────────────────┼───────────┤
│ + │ *                 │ Allow  │ ec2:DescribeInstances           │ AWS:${CustomRole}            │           │
│ + │ *                 │ Allow  │ ecs:DescribeTasks               │ AWS:${CustomRole}            │           │
│ + │ *                 │ Allow  │ securityhub:BatchImportFindings │ AWS:${CustomRole}            │           │
└───┴───────────────────┴────────┴─────────────────────────────────┴──────────────────────────────┴───────────┘
IAM Policy Changes
┌───┬───────────────┬────────────────────────────────────────────────────────────────────────────────┐
│   │ Resource      │ Managed Policy ARN                                                             │
├───┼───────────────┼────────────────────────────────────────────────────────────────────────────────┤
│ + │ ${CustomRole} │ arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole │
└───┴───────────────┴────────────────────────────────────────────────────────────────────────────────┘
(NOTE: There may be security-related changes not in this list. See https://github.com/aws/aws-cdk/issues/1299)

Do you wish to deploy these changes (y/n)? y
AwsSecurityhubFalcoEksIntegrationStack: deploying... [1/1]
[0%] start: Building and publishing 23af06be3d08822fbfabb7584213fde595fd9086a8cce59bf34f1eaa43bd30ae:current
[100%] success: Built and published 23af06be3d08822fbfabb7584213fde595fd9086a8cce59bf34f1eaa43bd30ae:current
AwsSecurityhubFalcoEksIntegrationStack: creating CloudFormation changeset...

 ✅  AwsSecurityhubFalcoEksIntegrationStack

✨  Deployment time: 54.51s

Stack ARN:
arn:aws:cloudformation:us-west-2:133776528597:stack/AwsSecurityhubFalcoEksIntegrationStack/0630f0c0-961e-11ee-8bf5-06e93086ece7
✨  Total time: 55.54s
```
The message above should confirm successful deployment of AwsSecurityhubFalcoEksIntegrationStack components

## Useful CDK commands

 * `cdk ls`          list all stacks in the app
 * `cdk synth`       emits the synthesized CloudFormation template
 * `cdk deploy`      deploy this stack to your default AWS account/region
 * `cdk diff`        compare deployed stack with current state
 * `cdk docs`        open CDK documentation

## Security

See [CONTRIBUTING](CONTRIBUTING.md#security-issue-notifications) for more information.

## License

This library is licensed under the MIT-0 License. See the [LICENSE](LICENSE) file.

