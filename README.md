## Table of Content
1. [Overview](#overview)
    - [Architecture](#architecture)
    - [Cost](#cost)
3. [Prerequisites](#prerequisites)
    - [Operating System](#operating-system)
4. [Deployment Steps](#deployment)
5. [Deployment Validation](#deployment-validation)
6. [Support and Troubleshooting](#support-and-troubleshooting)
7. [Cleanup](#cleanup)

## Overview

Container Runtime Security Monitoring on Amazon Elastic Kubernetes Service (EKS) with CNCF Falco and AWS Security Hub
Customers want a single and comprehensive view of the security posture of their cloud native workloads. Runtime security event monitoring is important to
running secure, operationally excellent, and reliable workloads,especially in environments that run containers and container
orchestration platforms. In this guidance, we show you how to useservices such as [AWS Security
Hub](https://aws.amazon.com/security-hub/) and [Falco](https://falco.org/),a [Cloud Native Computing Foundation](https://www.cncf.io/) project, to build a continuous container runtime security monitoring solution.

With this solution in place, you can collect runtime security findingsfrom multiple AWS regions running one or more containerized workloads on
AWS container orchestration platforms, such as [Amazon ElasticKubernetes Service (Amazon EKS)](https://aws.amazon.com/eks/) . The solution collates container run-time security findings across thoseregions into a designated account where you can have a unified view ofSecurity posture across regions and container workloads.

### Features and benefits

* Amazon Security Hub collects security findings from other AWS services using a standardized AWS Security Findings Format (ASFF). 
* CNCF Falco provides the ability to detect security events at runtime for containers and send them via integrations to external Log management systems Security Hub provides a custom integrations feature using ASFF to enable collection and aggregation of findings that are generated by custom security products.
* This guidance uses integration with Amazon FireLens/FluentBit with Amazon CloudWatch Logs and Lambda to enrich security events logs received from Falco, process them into ASFF format and import into Security Hub.
*  Using Security Hub cross-region configurable aggregation, it is possible to ingest and aggregate security events from multiple Amazon EKS platform deployments in various regions thus providing Security and DevOps teams with a "single pane of glass" Security management portal that contains security incidents from all those platforms and allows for ITIL style automation of remediation.


### Use cases

* Consolidate all of customers' Container security events from multiple application platforms in one place for continuous log retention for security, compliance and audit purposes.
* Format security events into AWS Standard format (ASFF) and import them into central security events monitoring and management portal (Security Hub).
* Aggregate security events from multiple Container application platforms possibly deployed in different AWS regions into "Single pane of glass" portal for Security, DevOps and other teams to efficiently detect container Security threats and collaborate on their triage & resolution.
* Provide security mitigation workflow options to remediate certain Security incidents with AWS services

## Architecture

Amazon Security Hub collects security findings from other AWS services using a standardized [AWS Security Findings Format
(ASFF)](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-findings-format.html). Falco provides
the ability to detect security events at runtime forcontainers. [Partner
integrations](https://aws.amazon.com/security-hub/partners/) likeFalco are also available on Security Hub and use ASFF. Security Hub
provides a custom integrations feature using ASFF to enable collectionand aggregation of findings that are generated by custom security
products.

The solution in this guidance uses [AWS FireLens](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/using_firelens.html), [Amazon
CloudWatch Logs](http://aws.amazon.com/cloudwatch), and [AWSLambda](http://aws.amazon.com/lambda) to enrich logs from Falco and
populate Security Hub.

<img src="images/Falco-components-schema.svg" width="40%">
<b>Figure 1: Architecture diagram of CNCF Falco continuous runtime security monitoring components in Kubernetes cluster</b>
<br/>
Falco provides streaming detection of unexpected behavior, configuration
changes, and attacks.

-   Uses [eBPF](https://ebpf.io/what-is-ebpf/) to monitor system activity for adverse behavior.
-   Integrates with Kubernetes, so you can protect your containers  infrastructure at scale.
-   Runtime protection is a fundamental layer of defense against  security blind spots and zero-day bugs in your software supply
    chain.
-   Streaming approach enables real-time response while minimizing storage costs and complexity.
-   Ready out-of-the-box with rules, which you can customize for you  environment.

Below is the Reference architecture implemented by this guidance .

<!-- ! [](images/falco_eks_integration_architecture_updated.png) -->
<img src="images/falco_eks_integration_architecture_updated.png" width="70%">
<b>Figure 2. Reference architecture of Container Runtime Security Monitoring on Amazon Elastic Kubernetes Service (EKS)</b>

### Architecture steps

1. FluentBit /[AWS FireLens](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/using_firelens.html) log event aggregation and [Cloud Native Computing Foundations (CNCF) Falco](https://www.cncf.io/projects/falco/) security monitoring components are deployed into [Amazon Elastic Kubernetes Service (EKS)](https://aws.amazon.com/eks) Clusters, running in same or different regions
2. CNCF Falco components monitor application containers running on EKS cluster nodes for possible security incidents (based on defined rules) at run time and  generate security events.
3. Security events are streamed to FluentBit/AWS FireLens log event aggregators running on EKS as well.
4. Aggregated security events are imported into [AWS Cloud Watch](https://aws.amazon.com/cloudwatch/) log streams, specified log groups 
5. AWS Lambda function get triggered by security events in CloudWatch log stream, detect and transform security event data into [Amazon Security Findings Format (ASFF)](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-findings-format.html) schema and import into regional [Amazon Security Hub](https://aws.amazon.com/security-hub/) instances
6. Security findings in ASFF format are available in regional Security Hub portals for acknowledgement and triage by regional teams.
7. Regional Security findings aggregated  into ”single pane of glass” central Security Hub portal that includes regional SecurityHub as members (can be one of the regional Hub instances) 
8. Security team users authenticate into the ”single pane of glass” central SecurityHub portal via [Amazon Identity and Access Management (IAM)](https://aws.amazon.com/iam/) , access is granted according to their IAM Roles
9. Aggregated security findings are available in the ”single pane of glass” central SecurityHub portal for acknowledgement and triage using workflows. 


### AWS Services used  in this Guidance

| **AWS service**  | Description |
|-----------|------------|
|[Amazon Security Hub](https://aws.amazon.com/security-hub/)|Core service -  aggregation and management of Security findings|
|[Amazon Elastic Kubernetes Service - EKS](https://aws.amazon.com/eks/)|Core service -  EKS service is used to run the secured container workloads|
|[Amazon Virtual Private Cloud - VPC](https://aws.amazon.com/vpc/)| Core Service - Network security layer |
|[Amazon Elastic Compute Cloud - EC2](https://aws.amazon.com/ec2/)| Core Service - EC2 instance power On Demand and Spot based EKS compute node groups for running container workloads|
|[Amazon Elastic Container Registry - ECR](https://aws.amazon.com/ecr/)|Core service - ECR registry is used to host application container images|
|[Amazon CloudWatch](https://aws.amazon.com/cloudwatch/)|Core service - stores Falco generated log events  |
|[Amazon Identity and Access Manager - IAM](https://aws.amazon.com/iam/))|Auxiliary service - provides user credentials and role mgmt  |

### Prerequisites

For successful deployment of guidance code, you should have the following in place:

1.  Active AWS accounts.

 Note: You can use different AWS accounts so you can validate Security Hub’s support for a multi-account setup. However, for a simpler
 configuration, you can use a single AWS account instead to deploy the Amazon EKS workloads in different regions, and send findings to
 regional instances of "regional" Security Hubs. If you are integrated with AWS Organizations, the designated Security Hub
 administrator account [will automatically have access to the member accounts](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-accounts.html).

2.  Amazon EKS cluster(s) deployed in AWS region

NOTE: this guidance does not provide code for deplying EKS clusters into your AWS accounts, but multiple examples can be found in this [project repositry](https://aws-ia.github.io/terraform-aws-eks-blueprints/getting-started/)

3. Security Hub instance(s) set up with an Administrator account in the same AWS region(s) as EKS cluster(s).

4. Security Hub instances set up in multiple regions to ingest and  rocess security events from Amazon EKS clusters with workloads. For instructions on how to automatically deploy Amazon EKS cluster with  arious add-ons please see Example and Documentation in the “Related Content” (see above **NOTE** )

5. AWS Cloud Development Kit (CDK) CLI [installed](https://docs.aws.amazon.com/cdk/latest/guide/getting_started.html#getting_started_install) on
    the member accounts to deploy the solution that provides the custom integration between Falco and Security Hub.

### Cost 

You are responsible for the cost of the AWS services used while running this Guidance. As of May 2024, the estimated cost for running this Guidance with two Amazon EKS clusters with 3 [m7g.xlarge](https://aws.amazon.com/ec2/instance-types/m7g/) compute nodes in the US East 1 (N. Virginia) and US East 2 (Ohio) Regions with 2 SecurityHub instances in these regions is approximately **\$1293.32 per month**. Refer to the AWS pricing [calculator]([https://aws.amazon.com/pricing/?aws-products-pricing](https://calculator.aws/#/estimate?id=9c32d5d8a5b6637d5a13eab5d4cb9c99c392d6f8)) for estimates for each AWS service used in this Guidance.

### Sample Cost table

The following table provides a sample cost breakdown for deploying this Guidance with the default parameters in the US East (N. Virginia) Region
for one month.

| **AWS service**  |  Cost \[USD\]  |Description |
|-----------|------------|------------|					
|Amazon EKS	- Regional EKS clusters |	\$146	| Number of EKS Clusters (2)	|				
|Amazon EC2 - Compute Nodes at EKS clusters |	\$656.29 |	Tenancy (Shared Instances), Operating system (Linux), Workload (Consistent, Number of instances: 6), Advance EC2 instance (m7g.xlarge), Pricing strategy (On-Demand Utilization: 90 %Utilized/Month), Enable monitoring (disabled), EBS Storage amount (30 GB), DT Inbound: Not selected (0 TB per month), DT Outbound: Internet (0 GB per month), DT Intra-Region: (0 TB per month)|
|Application Load Balancer - ALB and NLB for access to EKS K8s API and Application API |	\$33.33 |	Number of Application Load Balancers (2)|
|Network Load Balancer - ALB and NLB for access to EKS K8s API and Application API|	\$33.45 |	Number of Network Load Balancers (2), Average number of new TCP connections (1 per second), Average TCP connection duration (1 seconds), Processed bytes per NLB for TCP (50 GB per month)|					
|AWS Security Hub - Regional Security Hub| \$100.00 | Number of Accounts (2), Number of Finding Ingested per Account (1000), Number of Automation Rules (10), Number of criteria in each automation rule (2)|		
|Amazon CloudWatch - CloudWatch logs with Falco events and metrics | \$60.27 |	Logs Delivered to CloudWatch Logs: Data Ingested (50 GB), Standard Logs: Data Ingested (10 GB), Number of Metrics (includes detailed and custom metrics) (100)|
|AWS Lambda	- Processing Log events into ASFF records for SecurityHub - across regions | \$0.68 |	Architecture (x86), Architecture (x86), Invoke Mode (Buffered), Amount of ephemeral storage allocated (1024 MB), Number of requests (100 per minute) |					
|VPN Connection	- VPC for hosting EKS clusters and workloads running on them | \$256 | Working days per month (22), Number of Site-to-Site VPN Connections (0), Number of subnet associations (2) |					
|Public IPv4 Address - VPC for hosting EKS clusters and workloads running on them| \$7.3 |	Number of In-use public IPv4 addresses (2), Number of Idle public IPv4 addresses (0)|
|**Total estimated cost per month:**| **\$1293.92** | **deployment in 2 AWS regions**  |

NOTE: this is just an estimate, actual Cost depend on footprints of AWS services deployed in production 

## Deployment

The project deploys a Lambda function, that enables receiving Falco security findings from AWS CloudWatch logs, formatting them in ASFF JSON format and integrating into Security Hub

The `cdk.json` file instructs the CDK Toolkit how to execute your application. It was updated for CDK 2.0 per document: https://docs.aws.amazon.com/cdk/v2/guide/migrating-v2.html.

This project is set up like a standard Python project.  The initialization process also creates a virtualenv within this project, stored under the `.venv` directory.  To create the virtualenv it assumes that there is a `python3` (or `python` for Windows) executable in your path with access to the `venv` package. If for any reason the automatic creation of the virtualenv fails, you can create the virtualenv manually.

To manually create a virtualenv on MacOS and Linux:

```bash
python3 -m venv .venv
```
After the init process completes and the virtualenv is created, you can use the following
steps to activate your virtualenv:

```bash
source .venv/bin/activate
```

If you are running the sample on a Windows platform, you would activate the virtualenv like this:

```bash
% .venv\Scripts\activate.bat
```

Once the virtualenv is activated, you can install the required dependencies.

```bash
python -m pip install -r requirements.txt
```

At this point you can now synthesize the CloudFormation template for this code.

```bash
cdk synth
```

To add additional dependencies, for example other CDK libraries, just add them to the `setup.py` file and rerun the `python -m pip install -r requirements.txt` command (or `pip install -r requirements.txt` from pip command prompt).

You may need to bootstrap your Account/region to CDK using command like:
```bash
cdk bootstrap aws://<account ID/us-west-2
......
[WARNING] @aws-cdk/aws-lambda.Code#asset is deprecated.
  use `fromAsset`
  This API will be removed in the next major release.
 ⏳  Bootstrapping environment aws://<account ID/us-west-2...
Trusted accounts for deployment: (none)
Trusted accounts for lookup: (none)
Using default execution policy of 'arn:aws:iam::aws:policy/AdministratorAccess'. Pass '--cloudformation-execution-policies' to customize.
CDKToolkit: creating CloudFormation changeset...
 ✅  Environment aws://<account ID/us-west-2 bootstrapped.
```
Then initialize deployment of artifacts into target Account/Region environment:

```
cdk deploy
...
[WARNING] @aws-cdk/aws-lambda.Code#asset is deprecated.
  use `fromAsset`
  This API will be removed in the next major release.

✨  Synthesis time: 1.03s

This deployment will make potentially sensitive changes according to your current security approval level (--require-approval broadening).
Please confirm you intend to make the following modifications:

IAM Statement Changes
┌───┬───────────────────┬────────┬─────────────────────────────────┬──────────────────────────────┬───────────┐
│   │ Resource          │ Effect │ Action                          │ Principal                    │ Condition │
├───┼───────────────────┼────────┼─────────────────────────────────┼──────────────────────────────┼───────────┤
│ + │ ${CustomRole.Arn} │ Allow  │ sts:AssumeRole                  │ Service:lambda.amazonaws.com │           │
├───┼───────────────────┼────────┼─────────────────────────────────┼──────────────────────────────┼───────────┤
│ + │ *                 │ Allow  │ ec2:DescribeInstances           │ AWS:${CustomRole}            │           │
│ + │ *                 │ Allow  │ ecs:DescribeTasks               │ AWS:${CustomRole}            │           │
│ + │ *                 │ Allow  │ securityhub:BatchImportFindings │ AWS:${CustomRole}            │           │
└───┴───────────────────┴────────┴─────────────────────────────────┴──────────────────────────────┴───────────┘
IAM Policy Changes
┌───┬───────────────┬────────────────────────────────────────────────────────────────────────────────┐
│   │ Resource      │ Managed Policy ARN                                                             │
├───┼───────────────┼────────────────────────────────────────────────────────────────────────────────┤
│ + │ ${CustomRole} │ arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole │
└───┴───────────────┴────────────────────────────────────────────────────────────────────────────────┘
(NOTE: There may be security-related changes not in this list. See https://github.com/aws/aws-cdk/issues/1299)

Do you wish to deploy these changes (y/n)? y
AwsSecurityhubFalcoEksIntegrationStack: deploying... [1/1]
[0%] start: Building and publishing 23af06be3d08822fbfabb7584213fde595fd9086a8cce59bf34f1eaa43bd30ae:current
[100%] success: Built and published 23af06be3d08822fbfabb7584213fde595fd9086a8cce59bf34f1eaa43bd30ae:current
AwsSecurityhubFalcoEksIntegrationStack: creating CloudFormation changeset...

 ✅  AwsSecurityhubFalcoEksIntegrationStack

✨  Deployment time: 54.51s

Stack ARN:
arn:aws:cloudformation:us-west-2:133776528597:stack/AwsSecurityhubFalcoEksIntegrationStack/0630f0c0-961e-11ee-8bf5-06e93086ece7
✨  Total time: 55.54s
```
The message above should confirm successful deployment of AwsSecurityhubFalcoEksIntegrationStack components

### Deployment Walkthrough

#### Set up a Falco Runtime Security

NOTE: This Guidance specifically uses integration of Falco with [Amazon FireLens](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/using_firelens.html)
and Amazon CloudWatch to send and collect security events. There is an option to use the companion OSS component called
[Falcosidekick](https://github.com/falcosecurity/falcosidekick) to send the security events to Amazon CloudWatch directly, it is not covered by
this Guidance.

-   Falco continuously scans the containers running in the pods and sends the security, debug, or audit events as JSON format as STDOUT.

-   FireLens then collects the JSON log file and processes/parses the  log files as per Fluent Bit configuration files.

-   After log transformation by Fluent Bit containers, the aggregated logs are
    sent to AWS CloudWatch as the final destination.

1. Clone the project repository

Git clone this repository to your deployment environment: 
```bash
git clone https://github.com/aws-solutions-library-samples/guidance-for-container-runtime-security-monitoring-on-amazon-eks-with-cncf-falco-amazon-securityhub
```
Navigate to directory `fluent-bit` - you will find two directorie called `aws` and `kubernetes`

`aws` – this is the directory that has the IAM policy called iam_role_policy.json, which you will attach to the compute node
IAM role which is automatically attached to the compute nodes when deploy an EKS cluster. This policy will give Falco running on the EKS
compute nodes ability to send/stream logs to Amazon CloudWatch.

`kubernetes` – this directory has three files: configmap.yaml, daemonset.yaml, and service-account.yaml. These files will be applied to
create a ConfigMap for Fluent Bit configuration, DaemonSet to run pods on all compute nodes, and finally a Service Account for the RBAC cluster
role for authorization. All the files can be applied all at once or one by one using `kubectl apply` command

2. Set up IAM Permissions for Falco

Run the following command in order to create an IAM policy 
```bash
aws iam create-policy --policy-name EKS-CloudWatchLogs --policy-document file://./fluent-bit/aws/iam_role_policy.json
```
This creates a policy called *EKS-CloudWatchLogs* with privileges to
send logs to Amazon CloudWatch.

```bash
aws iam attach-role-policy --role-name <EKS-NODE-ROLE-NAME> --policy-arn `aws iam list-policies | jq -r '.[][] | select(.PolicyName == "EKS-CloudWatchLogs") | .Arn'`
``` 
NOTE: “EKS-NODE-ROLE-NAME” is the IAM role that is attached to the EKS compute nodes. You can find the role attached by checking any of EC2
node instances. For example, in the example below ‘eks-cluster-1-managed-ondemand’ is the role attached the node:

<img src="images/EKS_node_instance_IAMRole.jpg" width="70%" >
<!-- ![](images/eks_iam_role.png) <br/-->
<b>Figure 3. IAM Role attached to EC2 instance of EKS Compute node</b>
<br/>
Below is an example of the command to attach required IAM policies to EKS node
role above:
```bash
aws iam attach-role-policy --role-name eks-cluster-1-managed-ondemand --policy-arn \`aws iam list-policies | jq -r '.\[\]\[\] |
select(.PolicyName == "EKS-CloudWatchLogs") | .Arn'\`
```
3. Set up Fluentbit/Amazon FireLens Log Aggregation on EKS Cluster

To preview and update, if necessary, the configuration of Fluentbit/FireLens components, navigate to the `fluent-bit/kubernetes`
directory and review the configuration files (fluentbit-config-crio.yaml, daemonset.yaml and service-account.yaml) that will be applied.

NOTE: you can specify the target AWS region, CloudWatch log group and log stream names by adjusting the following parameters in the file:
[Fluentbit-config-crio.yaml](https://github.com/aws-solutions-library-samples/guidance-for-container-runtime-security-monitoring-on-amazon-eks-with-cncf-falco-amazon-securityhub/blob/main/fluent-bit/kubernetes/fluent-bit-config-crio.yaml)
```yaml
…

[OUTPUT]

Name cloudwatch
Match falco.\*\*
region us-west-2
log_group_name falco
log_stream_name alerts-eks
auto_create_group true
…
```
To apply Fluentbit/FireLens configuration, run the following command from the guidance root directory:

```bash
# first, create a namespace for Falco related components if it doesn’t exist yet kubectl create ns falco
kubectl create ns falco

# Deploy Fluentbit - FireLens integration
kubectl apply -f fluent-bit/kubernetes/ -n falco
```

It should generate an output like shown below confirming that all K8s objects are created in the target namespace:
```bash
configmap/Fluentbit-config created
daemonset.apps/fluentbit created
configmap/Fluentbit-config configured
serviceaccount/Fluentbit created
clusterrole.rbac.authorization.k8s.io/pod-log-reader created
clusterrolebinding.rbac.authorization.k8s.io/pod-log-crb created
```
That completes installation/configuration of FireLens/FluentBit integration

4. Falco Helm Template Configuration Update and Installation

Clone the [falcosecurity/falco](https://github.com/falcosecurity/charts) public Helm chart repository and add the Helm chart to the list of known repositories:

```bash
git clone https://github.com/falcosecurity/charts.git;
helm repo add falcosecurity https://falcosecurity.github.io/charts
helm repo update
```

Falco security monitoring behavior can be controlled by a [configuration parameters](https://github.com/falcosecurity/charts/tree/master/falco#introduction),
which can be supplied as runtime parameters while installing the chart or by creating a special purpose file, for example **values.yaml** (you
can give any name). Please reference this [page](https://github.com/falcosecurity/charts/tree/master/falco#introduction) to
understand all Falco chart configuration parameters, which control the run time behavior of Falco audit level, log level, output formats etc.

NOTE: The `jsonOutput property` is set to `false` in the Falco chart parameter file `values.yaml` by default. You need to set to true for JSON formatted output via Fluentbit as well as related properties. This guidance is not covering customization of Falco audit rules, which is a different important aspect of adopting this highly configurable solution.

```bash
...
# -- If "true", print falco alert messages and rules file
# loading/validation results as json, which allows for easier
# consumption by downstream programs. Default is "false".
json_output: true

# -- When using json output, whether or not to include the "output" property
# itself (e.g. "File below a known binary directory opened for writing
# (user=root ....") in the json output.
json_include_output_property: true

# -- When using json output, whether or not to include the "tags" property
# itself in the json output. If set to true, outputs caused by rules
# with no tags will have a "tags" field set to an empty array. If set to
# false, the "tags" field will not be included in the json output at all.
json_include_tags_property: true

```
Please refer to the sample of [values.yaml ](https://github.com/aws-solutions-library-samples/guidance-for-container-runtime-security-monitoring-on-amazon-eks-with-cncf-falco-amazon-securityhub/blob/main/falco-helm-chart/values_customize_sample.yaml) with customizations above in the sample code repository for your reference.

Please note where Falco rules configuration files will be deployed in Falco pods, as specified in parameters in the `values.yaml` file above:

```bash
..
# The files will be read in the order presented here, so make sure if
# you have overrides they appear in later files.
# -- The location of the rules files that will be consumed by Falco.

rules_file:

- /etc/falco/falco_rules.yaml
- /etc/falco/falco_rules.local.yaml
- /etc/falco/rules.d
…
```

After performing customization of the 'values.yaml` file (and other optional customizations, e.g., enabling Falcosidekick - outside of this Guidance scope) install the Falco Helm chart running the following command:

```bash
helm install falco -f <path-to-/values.yaml> falcosecurity/falco -n falco

#for example if cloned Falco Helm chart repository is in `./charts/charts/falco` location:
helm install falco -f ./charts/charts/falco/values.yaml falcosecurity/falco -n falco 
```
You should see an output similar to the following:
```bash
NAME: falco

LAST DEPLOYED: Thu May 11 12:02:40 2023
NAMESPACE: falco
STATUS: deployed
REVISION: 1
NOTES:
Falco agents are spinning up on each node in your cluster. After a few seconds, they are going to start monitoring your containers looking for security issues.
```
**NOTE: No further action should be required.** 

Once this deployment is completed, Falco will be monitoring your Kubernetes cluster pods for security or suspicious events behavior (configured in Falco rules) an sending the log events to FireLens, which transforms the JSON logs as per the configuration settings specified and finally sends the logs to CloudWatch.

At the end, you should have the following pods and deployments related to Falco:
```bash
kubectl -n falco get pods
```
You should see the following output:
```bash
NAME READY STATUS RESTARTS AGE
NAME              READY   STATUS    RESTARTS   AGE
falco-7lvsz       2/2     Running   0          3m1s
falco-pvnkk       2/2     Running   0          3m1s
falco-vdvc8       2/2     Running   0          3m1s
fluentbit-f9hft   1/1     Running   0          16m
fluentbit-hdrj4   1/1     Running   0          16m
fluentbit-wqtv9   1/1     Running   0          16m
```

Both Fluentbit/FireLens and Falco pods should up and running in the specified EKS namespace `falco` and correspond to number of active EKS node:

(Optional) To check that settings specified in *values.yaml* file are correctly set in the Falco pods, you can connect to one of the pods
(total number should be equal to number of EKS nodes) using the following command:
```bash
kubectl -n falco exec -it <falco-pod-name> -- /bin/bash
```
Once inside Falco pod, navigate to its deployment directory `/etc/falco` and verify that `falco.yaml` file has `json_output settings` as specified above:
```bash
# ls /etc/falco
falco.yaml falco_rules.yaml
# cat /etc/falco/falco.yaml | grep json

json_include_output_property: true
json_include_tags_property: true
json_output: true
library_path: libjson.so
name: json
```

#### Deploy Integration with SecurityHub

In this section, you will learn how to deploy the solution and enable the CloudWatch Logs group as an event trigger source. Enabling the
CloudWatch Logs group is the trigger for running the Lambda function in AWS accounts.

To deploy the sample code into your AWS account:

1.  Follow the instructions above to build and deploy AWS Integration components via AWS CDK. Make sure that you deploy the solution to the region(s) hosting your Amazon EKS clusters.

2.  Navigate to the [AWS Lambda Console ](https://console.aws.amazon.com/lambda) and confirm that you see the newly created Lambda function. You will use this function in the next section.

<img src="images/Imported_Lambda_Function.jpg" width="70%">
<!-- ![](images/DeployedlambdaFunction.png) <br/ -->
<b>Figure 4: Imported Lambda function for Falco events integration with Security Hub</b>
<br/>
3. Enable Trigger from the CloudWatch Logs group

- In the AWS Management Console, select the Lambda function shown in Figure 4 —and then, on the Function overview screen, select *+ Add trigger*.

- On the ‘Add trigger’ screen, provide the following information and then select Add, as shown in Figure 3.

    -   Trigger configuration – From the drop-down, select ‘CloudWatch logs’.
    -   Log group – Choose the Log group you noted in Step 4 of the [Prerequisites](#prerequisites). In our setup, the
        log group for Amazon EKS clusters, deployed in separate AWS accounts, was set with the same value (falco).
    -   Filter name – Provide a name for the filter, for example falco-events-trigger.
    -   Filter pattern – *optional* – Leave this field blank.

 <img src="images/Lambda_trigger_definition.jpg" width="70%" >
 <!-- ![](images/LambdaFunction_Trigger.png) <br/ -->
 <b>Figure 5: Configuration of Lambda function trigger from CloudWatch Log group</b>
<br/>
NOTE: Repeat these steps (as applicable) to set up triggers for the Lambda functions deployed in other AWS region(s) where EKS cluster(s) and
SecurutyHub instance(s) are provisioned.

### Deployment Validation

Now that you’ve deployed the solution, you will verify that it’s working.

With the [default rules](https://github.com/falcosecurity/rules/blob/3ceea88eeb6710e2c3d2726805a4ff0e93862de9/rules/falco_rules.yaml),
Falco generates alerts for “suspicious” activities such as:

-   An attempt to write to a file below the /etc folder in a container.
    The /etc folder contains important system configuration files.
-   An attempt to open a sensitive file (such as /etc/shadow) for
    reading.

To test your Falco deployment, you can manually perform such activities to generate Falco alerts that are reported as Security Hub findings in
the same account. Then you will review the findings.

#### Test Deployment in AWS Region 1

1.  Run the following commands to simulate hacker attack which should trigger an alert in AWS Region 1, which is running an Amazon EKS
    cluster. Replace *&lt;pod_name&gt; *with your own value for test pod name
```bash
kubectl -n &lt;namespace&gt; exec -it &lt;pod_name&gt; -- /bin/bash
touch /etc/1
touch /etc/2
touch /etc/3
cat /etc/shadow &gt; /dev/null
```

2.  (Optional) To see the log generated by Falco security event pushed to CloudWatch via Amazon Fluentbit/FireLens integration, you can
    take a look in the *falco* Log Group, *alerts_eks* folder contents and review Log entries generated after simulation of container hacking:

<img src="images/CloudWatch_log_entry.jpg" width="70%">
<!--
![](images/cloudwatch_log_part1.png) <br/>
![](images/cloudwatch_log_part2.png) <br/>
-->
<br/>
<b>Figure 6: CloudWatch Log entries from CNCF Falco processed by Fluentbit/FireLens</b>

3.  (Optional) To see the log generated by Lambda function that handles new security events appearing in the CloudWatch logs above, you can
    navigate to the */aws/lambda/AwsSecurityhubFalcoEcsEksIn-lambdafunction*-XXXXX Log Group and open one of the entries:

<img src="images/Lambda_function_log.jpg" width="70%" >
<!-- ![](images/cloudwatch_log_fragment1.png) <br/ -->
<b>Figure 7: Lambda function logs showing script output statements</b>
<br/>
The highlighted debugging message confirms that security event was converted to ASFF format and imported into regional SecurityHub
instance

4.  To see the list of security findings, authenticate in to your Security Hub with ‘admin’ account and navigate to Findings. You will see the alerts generated by Falco, including the Falco generated event title, and the instance where the alert was triggered.

<img src="images/SecurityHub_New_Findings.jpg" width="60%" >
<!-- ![](images/image9.png) <br/ -->
<b>Figure 8: Security Findings in regional Security Hub originating from Falco event</b>
<br/>
5. To see more detail of a Security finding, check the box next to the finding in SecurityHub. The figure below shows some of the details for the ‘Read sensitive file by untrusted program’ finding.

 <img src="images/SecurityHub_Findings_Details2.jpg" width="50%" >
<!-- ![](images/image10.png) <br/ -->
<b>Figure 9: Read Sensitive file security finding in Security Hub – detailed view</b>
<br/>
 In the screenshot below, you can see the `Resources` details of above finding  that includes the instance ID of the Amazon EKS cluster node.
 In our example, this is the [Amazon Elastic Compute Cloud (Amazon EC2)](http://aws.amazon.com/ec2) instance.

 <img src="images/SecurityHub_Findings_Resources.jpg" width="60%" >
 <!-- ![](images/image11.png) <br/ -->
 <b>Figure 10: Sensitive file read security finding – Resources detail</b>
<br/><br/>

#### Review Security findings from all Regions in the aggregated Security Hub

1.  Using designated Security Hub administrator account, authenticate to the Security Hub instance that aggregates events/findings from other AWS Regions (which may be one of regional instances as well) and navigate to ‘Findings’.
NOTE: when logged in to regional Security Hub instance, there are links navigating to the "central" as shown at the top of the screen like shown below:

<img src="images/Security_Hub_Aggregated_Findings.jpg" width="70%" >
<!-- ![](images/image12.png) <br/-->
<b>Figure 11: Link to the central SecurityHub instance from a regional one</b>
<br/>
2.  Navigate to the central (“single pane of glass”) Security Hub instance to review security posture across EKS workloads deployed in
AWS regions - findings from all aggregated regions are available in that view. The figure below shows security findings from different regions:
<img src="images/Security_Hub_Aggregated_Findings.jpg" width="60%" >
<!-- ![](images/image13.png) <br/-->
<b>Figure 12: Aggregated view of security findings in the “single pane of glass” central Security Hub</b>
<br/>
3. To see more information including AWS Region where EKS cluster where offending container is running, check the box next to the finding. The Figure below shows the region and instance details associated with a specific finding in member account 1.

<img src="images/Security_Hub_Aggregated_Findings_Region.jpg" width="60%" >
<!-- ![](images/image14.png) <br/ -->
<b>Figure 13: Security alert caused by sensitive container file under /etc showing AWS region of origin</b>
<br/>
4. To change status of a Security finding (e.g., to track an actual notification to responsible teams for remediations), select one or more security findings using filter such as ‘Company name’ (*AnyCompany* in the example below) etc. and select ‘WorkflowStatus’ option to desired one from the drop-down list to update the status of security remediation workflow:

<img src="images/SecurityHub_Workflow_Notified.jpg" width="70%">
<!-- ![](images/image15.png) <br/ -->
<b>Figure 14: Changing security issue response workflow status from the Security Hub aggregated account</b>
<br/>
Now security findings workflow status will show as ‘Notified” indicating that the teams were notified of those security events. Finding status can be further updated to ‘Resolved’ (if root cause gets addressed) or ‘Suppressed’ (if security team decides that detected security events don’t constitute an actual threat and/or can be reviewed later):

<img src="images/SecurityHub_Findings_Notified.jpg" width="70%">
<!-- ![](images/image16.png) <br/ -->
<b>Figure 15: Updated security issues workflow status from the Security Hub aggregated account</b>
<br/>
NOTE: updating ‘Workflow Status’ of security findings can be also performed in regional Security Hub instances by authorized users and that status would be reflected in the aggregated Security Hub account as well.

By centralizing and enriching the security findings by CNCF Falco, your Security teams can detect security anomalies in containers more
quickly or perform automated remediation on the impacted resources.

 
### Support and Troubleshooting

This guidance is an [Open-Source](https://opensource.com/resources/what-open-source) project maintained by AWS Solution Architects. **It is not part of AWS Services and support is provided best-effort by** AWS Solution Architects and the user community.

To post feedback, submit feature ideas or report bugs, you can use the [Issues section](https://github.com/aws-solutions-library-samples/guidance-for-container-runtime-security-monitoring-on-amazon-eks-with-cncf-falco-amazon-securityhub/issues) of the sample GitHub repository.

If you are interested in contributing to the guidance sample code, you can follow the [Contribution
guide.](https://github.com/aws-solutions-library-samples/guidance-for-container-runtime-security-monitoring-on-amazon-eks-with-cncf-falco-amazon-securityhub/blob/main/CONTRIBUTING.md)

#### Troubleshooting

For troubleshooting AWS components of the Guidance (FireLens/Fluentbit, CloudWatch, Lambda, SecurityHub) please collect operational support
information from the problematic component (CloudWatch and Lambda log files, various metrics and logs from EKS clusters etc.) and review them
for error messages, then contact AWS Support if needed.

Lambda security log event transformation and import function Python code has been verified for Runtime 3.8 and 3.9 running on x86_64 architecture:

<img src="images/Lambda_runtime_environment.jpg" width="70%" >
<!-- ![](images/image17.png) <br/-->
<b>Figure 16: Lambda function runtime settings in AWS Console</b>
<br/><br/>
NOTE: Setting up “Update runtime version” to Auto should ensure that when Python runtime environment gets deprecated, it would be automatically
updated for this function which should keep it working.

Since CNCF Falco is an Open Source project, for troubleshooting Falco components for please follow the project repository for
[issues](https://github.com/falcosecurity/falco/issues) as well as this Kubernetes Slack [channel](https://kubernetes.slack.com/archives/CMWH3EH32)

You can extend this solution in a number of ways:

-   You can forward findings across AWS regions using a single source to security information and event management (SIEM) tools such as Splunk.
-   You can perform automated remediation activities based on the findings generated, using Lambda.
-   To learn more about managing a centralized Security Hub administrator account, see [Managing administrator and member
accounts](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-accounts.html).
-   To learn more about working with ASFF, see [AWS Security Finding Format (ASFF)](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-findings-format.html) in the documentation. 
-   To learn more about the Falco engine and rule structure, see the [Falco documentation](https://falco.org/docs/getting-started/falco-kubernetes-quickstart/).

## Cleanup 
In order to unstall the guidance, execute the following commands: 

1.	Delete the CloudWatch Logs trigger from the Lambda functions that were created in the section 'Enable the CloudWatch Logs' group.
2.	Delete the Lambda functions by deleting the CloudFormation stack, created in the section 'Deploy Integration with SecurityHub'.
3.	Uninstall Falco security components by running the following commands to verify and delete Helm chart release:

```bash
helm ls -n falco

NAME 	NAMESPACE	REVISION	UPDATED                             	STATUS	CHART      	APP VERSION
falco	falco    	1       	2023-05-11 12:02:40.459092 -0700 PDT	deployed	falco-3.1.5	0.34.1     

helm delete falco -n falco
….
<deletion confirmation message>
```
4. Uninstall FluentBut/FireLens integration by running the following commands:
```bash
cd <guidance home>
# Delete Fluentbit - FireLens integration
kubectl delete -f ./fluent-bit/kubernetes/ -n falco
```
(Optional, only if no longer needed for other workloads) Delete Amazon EKS cluster(s) created as part of the [Prerequisites](#prerequisites).

## License

This library is licensed under the MIT-0 License. See the [LICENSE](LICENSE) file.
